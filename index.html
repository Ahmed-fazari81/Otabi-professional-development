<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù†ÙŠ - Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¹ÙˆØªØ¨ÙŠ</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .app {
      background: #ffffff;
      width: 100%;
      max-width: 450px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 30px;
      position: relative;
    }

    header {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 15px;
      line-height: 1.8;
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 15px;
    }

    h1 {
      text-align: center;
      font-size: 22px;
      margin: 20px 0 25px;
      color: #2c3e50;
      position: relative;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: #3498db;
      border-radius: 2px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 700;
      font-size: 14px;
      color: #34495e;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 18px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .buttons {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }

    button {
      flex: 1;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }

    button.secondary:hover {
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    #notification {
      display: none;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
      text-align: center;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notification-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .notification-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .notification-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: #fff;
      width: 90%;
      max-width: 500px;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ecf0f1;
    }

    .modal-header h3 {
      margin: 0;
      color: #2c3e50;
      font-size: 20px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
      margin-top: 15px;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      font-weight: 700;
      text-align: center;
    }

    th:first-child {
      border-radius: 0 10px 0 0;
    }

    th:last-child {
      border-radius: 10px 0 0 0;
    }

    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #ecf0f1;
      background: #fafafa;
    }

    tr:hover td {
      background: #e8f4f8;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      padding: 30px;
      font-style: italic;
    }

    .close-btn {
      margin-top: 20px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4) !important;
    }

    #otherPlace {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .required::after {
      content: ' *';
      color: #e74c3c;
    }

    @media (max-width: 480px) {
      .app {
        padding: 20px;
      }
      
      header {
        font-size: 13px;
      }
      
      h1 {
        font-size: 18px;
      }
    }
  </style>
</head>

<body>

<div class="app">

  <header>
    <div>Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†</div>
    <div>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
    <div>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¹ÙˆØªØ¨ÙŠ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</div>
  </header>

  <h1>Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù†ÙŠ</h1>

  <div id="notification"></div>

  <label class="required">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
  <input type="date" id="date" required>

  <label class="required">Ø§Ù„Ø­ØµØ©</label>
  <select id="session" required>
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ØµØ©</option>
    <option value="Ø§Ù„Ø£ÙˆÙ„Ù‰">Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠØ©">Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
    <option value="Ø§Ù„Ø«Ø§Ù„Ø«Ø©">Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
    <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©">Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</option>
    <option value="Ø§Ù„ÙØ³Ø­Ø©">Ø§Ù„ÙØ³Ø­Ø©</option>
    <option value="Ø§Ù„Ø®Ø§Ù…Ø³Ø©">Ø§Ù„Ø®Ø§Ù…Ø³Ø©</option>
    <option value="Ø§Ù„Ø³Ø§Ø¯Ø³Ø©">Ø§Ù„Ø³Ø§Ø¯Ø³Ø©</option>
    <option value="Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©">Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©</option>
    <option value="Ø§Ù„Ø«Ø§Ù…Ù†Ø©">Ø§Ù„Ø«Ø§Ù…Ù†Ø©</option>
  </select>

  <label class="required">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø¹Ù„Ù…</label>
  <input type="text" id="name" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">

  <label class="required">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
  <input type="text" id="job" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹Ù„Ù…ØŒ Ù…Ø¯ÙŠØ±ØŒ Ù…Ø±Ø´Ø¯">

  <label class="required">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
  <input type="text" id="topic" required placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· Ø£Ùˆ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬">

  <label class="required">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ†ÙÙŠØ°</label>
  <select id="placeSelect" onchange="toggleOtherPlace()" required>
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù†</option>
    <option value="Ù‚Ø§Ø¹Ø© Ø§Ù„Ø¹ÙˆØªØ¨ÙŠ">Ù‚Ø§Ø¹Ø© Ø§Ù„Ø¹ÙˆØªØ¨ÙŠ</option>
    <option value="Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø­Ø§Ø³ÙˆØ¨">Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø­Ø§Ø³ÙˆØ¨</option>
    <option value="Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠØ§ØªÙŠØ©">Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠØ§ØªÙŠØ©</option>
    <option value="Ù‚Ø§Ø¹Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ù‡Ù†ÙŠ">Ù‚Ø§Ø¹Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ù‡Ù†ÙŠ</option>
    <option value="Ù…Ø±ÙƒØ² Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„Ù…">Ù…Ø±ÙƒØ² Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„Ù…</option>
    <option value="other">Ø£Ø®Ø±Ù‰</option>
  </select>

  <input type="text" id="otherPlace" placeholder="Ø§ÙƒØªØ¨ Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ†ÙÙŠØ°">

  <label>Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
  <input type="text" id="target" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù„Ø§Ø¨ Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±">

  <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
  <textarea id="notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>

  <div class="buttons">
    <button onclick="submitData()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button class="secondary" onclick="openModal()">Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
  </div>

</div>

<div class="modal" id="modal" onclick="closeModalOutside(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <small id="todayDate" style="color: #7f8c8d;"></small>
    </div>
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
          <th>Ø§Ù„Ø­ØµØ©</th>
          <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
        </tr>
      </thead>
      <tbody id="reservations">
        <tr><td colspan="3" class="empty-state">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
      </tbody>
    </table>
    <button class="close-btn" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script>
  // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø·Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Google Apps Script
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxlmaxC_WeeuAR11VWGzsq6pMdAoXQY2RX79OfNRv-mx7ZRaGHt3JVjb1vAVefEMHJBgw/exec';

  document.addEventListener('DOMContentLoaded', function () {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    
    const todayDisplay = new Date().toLocaleDateString('ar-OM', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    document.getElementById('todayDate').textContent = todayDisplay;
  });

  function toggleOtherPlace() {
    const select = document.getElementById('placeSelect');
    const other = document.getElementById('otherPlace');
    const isOther = select.value === 'other';
    
    other.style.display = isOther ? 'block' : 'none';
    other.required = isOther;
    
    if (!isOther) {
      other.value = '';
    }
  }

  function showNotification(message, type) {
    const notif = document.getElementById('notification');
    notif.className = `notification-${type}`;
    notif.innerHTML = message;
    notif.style.display = 'block';
    
    setTimeout(() => {
      notif.style.display = 'none';
    }, 5000);
  }

  function validateForm() {
    const requiredFields = [
      { id: 'date', name: 'Ø§Ù„ØªØ§Ø±ÙŠØ®' },
      { id: 'session', name: 'Ø§Ù„Ø­ØµØ©' },
      { id: 'name', name: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù' },
      { id: 'job', name: 'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ' },
      { id: 'topic', name: 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹' },
      { id: 'placeSelect', name: 'Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ†ÙÙŠØ°' }
    ];

    for (let field of requiredFields) {
      const el = document.getElementById(field.id);
      let value = el.value.trim();
      
      if (field.id === 'placeSelect' && value === 'other') {
        const otherPlace = document.getElementById('otherPlace');
        if (!otherPlace.value.trim()) {
          showNotification(`âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ Ø­Ù‚Ù„ "Ø£Ø®Ø±Ù‰"`, 'warning');
          otherPlace.focus();
          return false;
        }
        continue;
      }
      
      if (!value || value === '') {
        showNotification(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø­Ù‚Ù„: ${field.name}`, 'warning');
        el.focus();
        return false;
      }
    }
    
    return true;
  }

  function submitData() {
    if (!validateForm()) return;

    const placeSelect = document.getElementById('placeSelect');
    let place = placeSelect.value;
    
    if (place === 'other') {
      place = document.getElementById('otherPlace').value.trim();
    }

    const payload = {
      date: document.getElementById('date').value,
      session: document.getElementById('session').value,
      name: document.getElementById('name').value.trim(),
      job: document.getElementById('job').value.trim(),
      topic: document.getElementById('topic').value.trim(),
      place: place,
      target: document.getElementById('target').value.trim(),
      notes: document.getElementById('notes').value.trim()
    };

    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¬Ø² "${place}" ÙÙŠ Ø§Ù„Ø­ØµØ© ${payload.session} Ø¨ØªØ§Ø±ÙŠØ® ${payload.date}ØŸ`;
    if (!confirm(confirmMessage)) return;

    const btn = document.querySelector('button[onclick="submitData()"]');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

    console.log('Sending:', payload);

    fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(res => {
      console.log('Response status:', res.status);
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      return res.text();
    })
    .then(text => {
      console.log('Raw response:', text);
      
      if (!text || text.trim() === '') {
        throw new Error('Empty response from server');
      }

      let res;
      try {
        res = JSON.parse(text);
      } catch (e) {
        throw new Error('Invalid JSON: ' + text.substring(0, 100));
      }

      btn.disabled = false;
      btn.textContent = originalText;

      if (res.conflict) {
        showNotification(res.message, 'error');
      } else if (res.success) {
        showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        document.getElementById('session').value = '';
        document.getElementById('name').value = '';
        document.getElementById('job').value = '';
        document.getElementById('topic').value = '';
        document.getElementById('placeSelect').value = '';
        document.getElementById('otherPlace').style.display = 'none';
        document.getElementById('otherPlace').value = '';
        document.getElementById('target').value = '';
        document.getElementById('notes').value = '';
      } else {
        showNotification('âŒ Ø®Ø·Ø£: ' + (res.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
      }
    })
    .catch(err => {
      console.error('Fetch error:', err);
      btn.disabled = false;
      btn.textContent = originalText;
      showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message, 'error');
    });
  }

  function openModal() {
    document.getElementById('modal').style.display = 'flex';
    loadTodayReservations();
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  function closeModalOutside(event) {
    if (event.target.id === 'modal') {
      closeModal();
    }
  }

  function loadTodayReservations() {
    const tbody = document.getElementById('reservations');
    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

    const url = `${SCRIPT_URL}?action=today`;
    console.log('Fetching:', url);

    fetch(url)
      .then(res => {
        console.log('Response status:', res.status);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return res.text();
      })
      .then(text => {
        console.log('Raw response:', text);
        
        if (!text || text.trim() === '') {
          throw new Error('Empty response from server');
        }

        let res;
        try {
          res = JSON.parse(text);
        } catch (e) {
          throw new Error('Invalid JSON: ' + text.substring(0, 100));
        }
        
        if (!res.success) {
          tbody.innerHTML = `<tr><td colspan="3" class="empty-state">âŒ Ø®Ø·Ø£: ${res.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td></tr>`;
          return;
        }
        
        if (!res.data || res.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty-state">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</td></tr>';
          return;
        }
        
        const sessionOrder = ['Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø§Ù„Ø«Ø§Ù†ÙŠØ©', 'Ø§Ù„Ø«Ø§Ù„Ø«Ø©', 'Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©', 'Ø§Ù„ÙØ³Ø­Ø©', 'Ø§Ù„Ø®Ø§Ù…Ø³Ø©', 'Ø§Ù„Ø³Ø§Ø¯Ø³Ø©', 'Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©', 'Ø§Ù„Ø«Ø§Ù…Ù†Ø©'];
        res.data.sort((a, b) => {
          return sessionOrder.indexOf(a.session) - sessionOrder.indexOf(b.session);
        });
        
        tbody.innerHTML = '';
        res.data.forEach(r => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHtml(r.name)}</td>
            <td><strong>${escapeHtml(r.session)}</strong></td>
            <td>${escapeHtml(r.place)}</td>
          `;
          tbody.appendChild(row);
        });
      })
      .catch(err => {
        console.error('Error:', err);
        tbody.innerHTML = `<tr><td colspan="3" class="empty-state">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„<br><small>${err.message}</small></td></tr>`;
      });
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('Service Worker registered:', reg))
      .catch(err => console.log('Service Worker registration failed:', err));
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
</script>

</body>
</html>
